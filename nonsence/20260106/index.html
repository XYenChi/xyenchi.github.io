<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pytorch RISC-V | xyenchi's blog</title><meta name=keywords content><meta name=description content='官方 github 仓库CI
起了一个 ubuntu RISC-V 的 docker，使用 gcc14 和 python 3.12，但是 fail 很久了没修。
配置文件链接
x86 cross
酸鸽给 ArchLinux RISC-V python-pytorch 2.6.0 打了包，patch 文件链接
在 K1 上安装试了一下，不能直接用。
Python 3.13.11 (main, Dec 17 2025, 07:50:59) [GCC 15.2.1 20251112] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import torch
Traceback (most recent call last):
  File "<python-input-0>", line 1, in <module>
    import torch
  File "/usr/lib/python3.13/site-packages/torch/__init__.py", line 405, in <module>
    from torch._C import *  # noqa: F403
    ^^^^^^^^^^^^^^^^^^^^^^
ImportError: libprotobuf.so.29.2.0: cannot open shared object file: No such file or directory
经查询 ArchLinux 上的 libprotobuf 版本为 31，但是进行软链接仍找不到，于是尝试重新构建。
既然已经打成功了早期版本的包，何不复用。于是学习了 ArchLinux 打包指南
其中 asp 已不可用，使用pkgctl repo clone --protocol=https python-pytorch获取最新版 ArchLinux 官方 PKGBUILD。根据酸鸽的riscv64 patch进行修改。
主要是禁用了 cuda 删除了一些 RISC-V 中没有的包依赖。
跑了一整天摸鱼之后发现，-march=rv64gc 被错误地 parse 了。
copying torch/utils/data/datapipes/datapipe.pyi -> build/lib.linux-riscv64-cpython-313/torch/utils/data/datapipes
running build_ext
-- Building with NumPy bindings
-- Not using cuDNN
-- Not using CUDA
-- Not using XPU
-- Not using MKLDNN
-- Not using NCCL
-- Building with distributed package: 
  -- USE_TENSORPIPE=True
  -- USE_GLOO=True
  -- USE_MPI=False
-- Not using ITT
Copying functorch._C from functorch/functorch.so to /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so
copying functorch/functorch.so -> /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so
building &#39;torch._C&#39; extension
creating build/temp.linux-riscv64-cpython-313/torch/csrc
-march=rv64gc -mabi=lp64d -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer -fPIC -I/usr/include/python3.13 -c torch/csrc/stub.c -o build/temp.linux-riscv64-cpython-313/torch/csrc/stub.o -Wall -Wextra -Wno-strict-overflow -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unknown-pragmas -fno-strict-aliasing
error: command &#39;-march=rv64gc&#39; failed: No such file or directory

ERROR Backend subprocess exited when trying to invoke build_wheel
==> ERROR: A failure occurred in build().
    Aborting...
==> ERROR: Build failed, check /var/lib/archbuild/extra-riscv64/xyenchi/build
于是删了 PKGBUILD 中加 add_definition 到 cmake 里面的方法，写了 CFLAGS 和 CXXFLAGS，重新跑。
看起来还是会把 CFLAGS 识别错误，可能原本的 CC 不存在，改成 /usr/bin/gcc 试试。
改 /usr/bin/gcc 挺成功的，就是找不到 ROCm 相关的 .so 文件。 貌似 ROCm 不支持 RISC-V 但是旧版本的打出来了。禁用掉试试。
使用该 PKGBUILD 可以打出 pytorch 2.9.1，但仍需从 ArchLinux 官方 GitLab 仓库拉取相应 patch。'><meta name=author content="xyenchi"><link rel=canonical href=https://xyenchi.github.io/nonsence/20260106/><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://xyenchi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://xyenchi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://xyenchi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://xyenchi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://xyenchi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://xyenchi.github.io/nonsence/20260106/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://xyenchi.github.io/nonsence/20260106/"><meta property="og:site_name" content="xyenchi's blog"><meta property="og:title" content="Pytorch RISC-V"><meta property="og:description" content='官方 github 仓库CI 起了一个 ubuntu RISC-V 的 docker，使用 gcc14 和 python 3.12，但是 fail 很久了没修。 配置文件链接
x86 cross 酸鸽给 ArchLinux RISC-V python-pytorch 2.6.0 打了包，patch 文件链接
在 K1 上安装试了一下，不能直接用。
Python 3.13.11 (main, Dec 17 2025, 07:50:59) [GCC 15.2.1 20251112] on linux Type "help", "copyright", "credits" or "license" for more information. >>> import torch Traceback (most recent call last): File "<python-input-0>", line 1, in <module> import torch File "/usr/lib/python3.13/site-packages/torch/__init__.py", line 405, in <module> from torch._C import * # noqa: F403 ^^^^^^^^^^^^^^^^^^^^^^ ImportError: libprotobuf.so.29.2.0: cannot open shared object file: No such file or directory 经查询 ArchLinux 上的 libprotobuf 版本为 31，但是进行软链接仍找不到，于是尝试重新构建。
既然已经打成功了早期版本的包，何不复用。于是学习了 ArchLinux 打包指南 其中 asp 已不可用，使用pkgctl repo clone --protocol=https python-pytorch获取最新版 ArchLinux 官方 PKGBUILD。根据酸鸽的riscv64 patch进行修改。
主要是禁用了 cuda 删除了一些 RISC-V 中没有的包依赖。
跑了一整天摸鱼之后发现，-march=rv64gc 被错误地 parse 了。
copying torch/utils/data/datapipes/datapipe.pyi -> build/lib.linux-riscv64-cpython-313/torch/utils/data/datapipes running build_ext -- Building with NumPy bindings -- Not using cuDNN -- Not using CUDA -- Not using XPU -- Not using MKLDNN -- Not using NCCL -- Building with distributed package: -- USE_TENSORPIPE=True -- USE_GLOO=True -- USE_MPI=False -- Not using ITT Copying functorch._C from functorch/functorch.so to /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so copying functorch/functorch.so -> /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so building &#39;torch._C&#39; extension creating build/temp.linux-riscv64-cpython-313/torch/csrc -march=rv64gc -mabi=lp64d -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer -fPIC -I/usr/include/python3.13 -c torch/csrc/stub.c -o build/temp.linux-riscv64-cpython-313/torch/csrc/stub.o -Wall -Wextra -Wno-strict-overflow -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unknown-pragmas -fno-strict-aliasing error: command &#39;-march=rv64gc&#39; failed: No such file or directory ERROR Backend subprocess exited when trying to invoke build_wheel ==> ERROR: A failure occurred in build(). Aborting... ==> ERROR: Build failed, check /var/lib/archbuild/extra-riscv64/xyenchi/build 于是删了 PKGBUILD 中加 add_definition 到 cmake 里面的方法，写了 CFLAGS 和 CXXFLAGS，重新跑。
看起来还是会把 CFLAGS 识别错误，可能原本的 CC 不存在，改成 /usr/bin/gcc 试试。
改 /usr/bin/gcc 挺成功的，就是找不到 ROCm 相关的 .so 文件。 貌似 ROCm 不支持 RISC-V 但是旧版本的打出来了。禁用掉试试。
使用该 PKGBUILD 可以打出 pytorch 2.9.1，但仍需从 ArchLinux 官方 GitLab 仓库拉取相应 patch。'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="nonsence"><meta property="article:published_time" content="2026-01-05T00:00:03+00:00"><meta property="article:modified_time" content="2026-01-05T00:00:03+00:00"><meta property="og:image" content="https://xyenchi.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://xyenchi.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Pytorch RISC-V"><meta name=twitter:description content='官方 github 仓库CI
起了一个 ubuntu RISC-V 的 docker，使用 gcc14 和 python 3.12，但是 fail 很久了没修。
配置文件链接
x86 cross
酸鸽给 ArchLinux RISC-V python-pytorch 2.6.0 打了包，patch 文件链接
在 K1 上安装试了一下，不能直接用。
Python 3.13.11 (main, Dec 17 2025, 07:50:59) [GCC 15.2.1 20251112] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import torch
Traceback (most recent call last):
  File "<python-input-0>", line 1, in <module>
    import torch
  File "/usr/lib/python3.13/site-packages/torch/__init__.py", line 405, in <module>
    from torch._C import *  # noqa: F403
    ^^^^^^^^^^^^^^^^^^^^^^
ImportError: libprotobuf.so.29.2.0: cannot open shared object file: No such file or directory
经查询 ArchLinux 上的 libprotobuf 版本为 31，但是进行软链接仍找不到，于是尝试重新构建。
既然已经打成功了早期版本的包，何不复用。于是学习了 ArchLinux 打包指南
其中 asp 已不可用，使用pkgctl repo clone --protocol=https python-pytorch获取最新版 ArchLinux 官方 PKGBUILD。根据酸鸽的riscv64 patch进行修改。
主要是禁用了 cuda 删除了一些 RISC-V 中没有的包依赖。
跑了一整天摸鱼之后发现，-march=rv64gc 被错误地 parse 了。
copying torch/utils/data/datapipes/datapipe.pyi -> build/lib.linux-riscv64-cpython-313/torch/utils/data/datapipes
running build_ext
-- Building with NumPy bindings
-- Not using cuDNN
-- Not using CUDA
-- Not using XPU
-- Not using MKLDNN
-- Not using NCCL
-- Building with distributed package: 
  -- USE_TENSORPIPE=True
  -- USE_GLOO=True
  -- USE_MPI=False
-- Not using ITT
Copying functorch._C from functorch/functorch.so to /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so
copying functorch/functorch.so -> /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so
building &#39;torch._C&#39; extension
creating build/temp.linux-riscv64-cpython-313/torch/csrc
-march=rv64gc -mabi=lp64d -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer -fPIC -I/usr/include/python3.13 -c torch/csrc/stub.c -o build/temp.linux-riscv64-cpython-313/torch/csrc/stub.o -Wall -Wextra -Wno-strict-overflow -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unknown-pragmas -fno-strict-aliasing
error: command &#39;-march=rv64gc&#39; failed: No such file or directory

ERROR Backend subprocess exited when trying to invoke build_wheel
==> ERROR: A failure occurred in build().
    Aborting...
==> ERROR: Build failed, check /var/lib/archbuild/extra-riscv64/xyenchi/build
于是删了 PKGBUILD 中加 add_definition 到 cmake 里面的方法，写了 CFLAGS 和 CXXFLAGS，重新跑。
看起来还是会把 CFLAGS 识别错误，可能原本的 CC 不存在，改成 /usr/bin/gcc 试试。
改 /usr/bin/gcc 挺成功的，就是找不到 ROCm 相关的 .so 文件。 貌似 ROCm 不支持 RISC-V 但是旧版本的打出来了。禁用掉试试。
使用该 PKGBUILD 可以打出 pytorch 2.9.1，但仍需从 ArchLinux 官方 GitLab 仓库拉取相应 patch。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Nonsences","item":"https://xyenchi.github.io/nonsence/"},{"@type":"ListItem","position":2,"name":"Pytorch RISC-V","item":"https://xyenchi.github.io/nonsence/20260106/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pytorch RISC-V","name":"Pytorch RISC-V","description":"官方 github 仓库CI 起了一个 ubuntu RISC-V 的 docker，使用 gcc14 和 python 3.12，但是 fail 很久了没修。 配置文件链接\nx86 cross 酸鸽给 ArchLinux RISC-V python-pytorch 2.6.0 打了包，patch 文件链接\n在 K1 上安装试了一下，不能直接用。\nPython 3.13.11 (main, Dec 17 2025, 07:50:59) [GCC 15.2.1 20251112] on linux Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import torch Traceback (most recent call last): File \u0026#34;\u0026lt;python-input-0\u0026gt;\u0026#34;, line 1, in \u0026lt;module\u0026gt; import torch File \u0026#34;/usr/lib/python3.13/site-packages/torch/__init__.py\u0026#34;, line 405, in \u0026lt;module\u0026gt; from torch._C import * # noqa: F403 ^^^^^^^^^^^^^^^^^^^^^^ ImportError: libprotobuf.so.29.2.0: cannot open shared object file: No such file or directory 经查询 ArchLinux 上的 libprotobuf 版本为 31，但是进行软链接仍找不到，于是尝试重新构建。\n既然已经打成功了早期版本的包，何不复用。于是学习了 ArchLinux 打包指南 其中 asp 已不可用，使用pkgctl repo clone --protocol=https python-pytorch获取最新版 ArchLinux 官方 PKGBUILD。根据酸鸽的riscv64 patch进行修改。\n主要是禁用了 cuda 删除了一些 RISC-V 中没有的包依赖。\n跑了一整天摸鱼之后发现，-march=rv64gc 被错误地 parse 了。\ncopying torch/utils/data/datapipes/datapipe.pyi -\u0026gt; build/lib.linux-riscv64-cpython-313/torch/utils/data/datapipes running build_ext -- Building with NumPy bindings -- Not using cuDNN -- Not using CUDA -- Not using XPU -- Not using MKLDNN -- Not using NCCL -- Building with distributed package: -- USE_TENSORPIPE=True -- USE_GLOO=True -- USE_MPI=False -- Not using ITT Copying functorch._C from functorch/functorch.so to /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so copying functorch/functorch.so -\u0026gt; /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so building \u0026#39;torch._C\u0026#39; extension creating build/temp.linux-riscv64-cpython-313/torch/csrc -march=rv64gc -mabi=lp64d -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer -fPIC -I/usr/include/python3.13 -c torch/csrc/stub.c -o build/temp.linux-riscv64-cpython-313/torch/csrc/stub.o -Wall -Wextra -Wno-strict-overflow -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unknown-pragmas -fno-strict-aliasing error: command \u0026#39;-march=rv64gc\u0026#39; failed: No such file or directory ERROR Backend subprocess exited when trying to invoke build_wheel ==\u0026gt; ERROR: A failure occurred in build(). Aborting... ==\u0026gt; ERROR: Build failed, check /var/lib/archbuild/extra-riscv64/xyenchi/build 于是删了 PKGBUILD 中加 add_definition 到 cmake 里面的方法，写了 CFLAGS 和 CXXFLAGS，重新跑。\n看起来还是会把 CFLAGS 识别错误，可能原本的 CC 不存在，改成 /usr/bin/gcc 试试。\n改 /usr/bin/gcc 挺成功的，就是找不到 ROCm 相关的 .so 文件。 貌似 ROCm 不支持 RISC-V 但是旧版本的打出来了。禁用掉试试。\n使用该 PKGBUILD 可以打出 pytorch 2.9.1，但仍需从 ArchLinux 官方 GitLab 仓库拉取相应 patch。\n","keywords":[],"articleBody":"官方 github 仓库CI 起了一个 ubuntu RISC-V 的 docker，使用 gcc14 和 python 3.12，但是 fail 很久了没修。 配置文件链接\nx86 cross 酸鸽给 ArchLinux RISC-V python-pytorch 2.6.0 打了包，patch 文件链接\n在 K1 上安装试了一下，不能直接用。\nPython 3.13.11 (main, Dec 17 2025, 07:50:59) [GCC 15.2.1 20251112] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. \u003e\u003e\u003e import torch Traceback (most recent call last): File \"\", line 1, in \u003cmodule\u003e import torch File \"/usr/lib/python3.13/site-packages/torch/__init__.py\", line 405, in \u003cmodule\u003e from torch._C import * # noqa: F403 ^^^^^^^^^^^^^^^^^^^^^^ ImportError: libprotobuf.so.29.2.0: cannot open shared object file: No such file or directory 经查询 ArchLinux 上的 libprotobuf 版本为 31，但是进行软链接仍找不到，于是尝试重新构建。\n既然已经打成功了早期版本的包，何不复用。于是学习了 ArchLinux 打包指南 其中 asp 已不可用，使用pkgctl repo clone --protocol=https python-pytorch获取最新版 ArchLinux 官方 PKGBUILD。根据酸鸽的riscv64 patch进行修改。\n主要是禁用了 cuda 删除了一些 RISC-V 中没有的包依赖。\n跑了一整天摸鱼之后发现，-march=rv64gc 被错误地 parse 了。\ncopying torch/utils/data/datapipes/datapipe.pyi -\u003e build/lib.linux-riscv64-cpython-313/torch/utils/data/datapipes running build_ext -- Building with NumPy bindings -- Not using cuDNN -- Not using CUDA -- Not using XPU -- Not using MKLDNN -- Not using NCCL -- Building with distributed package: -- USE_TENSORPIPE=True -- USE_GLOO=True -- USE_MPI=False -- Not using ITT Copying functorch._C from functorch/functorch.so to /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so copying functorch/functorch.so -\u003e /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so building 'torch._C' extension creating build/temp.linux-riscv64-cpython-313/torch/csrc -march=rv64gc -mabi=lp64d -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer -fPIC -I/usr/include/python3.13 -c torch/csrc/stub.c -o build/temp.linux-riscv64-cpython-313/torch/csrc/stub.o -Wall -Wextra -Wno-strict-overflow -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unknown-pragmas -fno-strict-aliasing error: command '-march=rv64gc' failed: No such file or directory ERROR Backend subprocess exited when trying to invoke build_wheel ==\u003e ERROR: A failure occurred in build(). Aborting... ==\u003e ERROR: Build failed, check /var/lib/archbuild/extra-riscv64/xyenchi/build 于是删了 PKGBUILD 中加 add_definition 到 cmake 里面的方法，写了 CFLAGS 和 CXXFLAGS，重新跑。\n看起来还是会把 CFLAGS 识别错误，可能原本的 CC 不存在，改成 /usr/bin/gcc 试试。\n改 /usr/bin/gcc 挺成功的，就是找不到 ROCm 相关的 .so 文件。 貌似 ROCm 不支持 RISC-V 但是旧版本的打出来了。禁用掉试试。\n使用该 PKGBUILD 可以打出 pytorch 2.9.1，但仍需从 ArchLinux 官方 GitLab 仓库拉取相应 patch。\nK1 native 官方文档上用的是 conda 的脚本，但是没有找到可以直接用的 conda，不是很懂，但是算了。\nsource .venv/bin/activate pip install -U pip setuptools wheel pip install -r requirements.txt export USE_CUDA=0 export USE_NCCL=0 export USE_DISTRIBUTED=0 export USE_MPI=0 export USE_GLOO=0 export USE_MKLDNN=0 export BUILD_TEST=0 export BUILD_CAFFE2=0 python setup.py develop 起一个 python 虚拟环境，禁用掉只有 x86 能用的子模块跑，摸鱼一整天之后，成功oom了。\nFAILED: [code=1] caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o /usr/bin/c++ -DAT_PER_OPERATOR_HEADERS -DCAFFE2_BUILD_MAIN_LIB -DCPUINFO_SUPPORTED_PLATFORM=1 -DFMT_HEADER_ONLY=1 -DHAVE_MALLOC_USABLE_SIZE=1 -DHAVE_MMAP=1 -DHAVE_POSIX_FALLOCATE=1 -DHAVE_SHM_OPEN=1 -DHAVE_SHM_UNLINK=1 -DMINIZ_DISABLE_ZIP_READER_CRC32_CHECKS -DONNXIFI_ENABLE_EXT=1 -DONNX_ML=1 -DONNX_NAMESPACE=onnx_torch -DUSE_EXTERNAL_MZCRC -D_FILE_OFFSET_BITS=64 -Dtorch_cpu_EXPORTS -I/home/xyenchi/pytorch/build/aten/src -I/home/xyenchi/pytorch/aten/src -I/home/xyenchi/pytorch/build -I/home/xyenchi/pytorch -I/home/xyenchi/pytorch/nlohmann -I/home/xyenchi/pytorch/moodycamel -I/home/xyenchi/pytorch/torch/csrc/api -I/home/xyenchi/pytorch/torch/csrc/api/include -I/home/xyenchi/pytorch/caffe2/aten/src/TH -I/home/xyenchi/pytorch/build/caffe2/aten/src/TH -I/home/xyenchi/pytorch/build/caffe2/aten/src -I/home/xyenchi/pytorch/build/caffe2/../aten/src -I/home/xyenchi/pytorch/torch/csrc -I/home/xyenchi/pytorch/torch/headeronly -I/home/xyenchi/pytorch/third_party/miniz-3.0.2 -I/home/xyenchi/pytorch/third_party/kineto/libkineto/include -I/home/xyenchi/pytorch/third_party/cpp-httplib -I/home/xyenchi/pytorch/aten/src/ATen/.. -I/home/xyenchi/pytorch/c10/.. -I/home/xyenchi/pytorch/third_party/cpuinfo/include -I/home/xyenchi/pytorch/third_party/FP16/include -I/home/xyenchi/pytorch/third_party/fmt/include -I/home/xyenchi/pytorch/third_party/onnx -I/home/xyenchi/pytorch/build/third_party/onnx -I/home/xyenchi/pytorch/third_party/flatbuffers/include -isystem /home/xyenchi/pytorch/third_party/protobuf/src -isystem /home/xyenchi/pytorch/cmake/../third_party/eigen -isystem /home/xyenchi/pytorch/INTERFACE -isystem /home/xyenchi/pytorch/third_party/nlohmann/include -isystem /home/xyenchi/pytorch/third_party/concurrentqueue -isystem /home/xyenchi/pytorch/build/include -fvisibility-inlines-hidden -DNDEBUG -DSYMBOLICATE_MOBILE_DEBUG_HANDLE -O2 -fPIC -DC10_NODEPRECATED -Wall -Wextra -Werror=return-type -Werror=non-virtual-dtor -Werror=range-loop-construct -Werror=bool-operation -Wnarrowing -Wno-missing-field-initializers -Wno-unknown-pragmas -Wno-unused-parameter -Wno-strict-overflow -Wno-strict-aliasing -Wno-stringop-overflow -Wsuggest-override -Wno-psabi -Wno-error=old-style-cast -faligned-new -Wno-maybe-uninitialized -fno-math-errno -fno-trapping-math -Werror=format -Wno-dangling-reference -Wno-error=dangling-reference -Wno-stringop-overflow -O3 -DNDEBUG -DNDEBUG -fPIC -fdiagnostics-color=always -Wall -Wextra -Wdeprecated -Wunused -Wno-unused-parameter -Wno-missing-field-initializers -Wno-array-bounds -Wno-unknown-pragmas -Wno-strict-overflow -Wno-strict-aliasing -Wredundant-move -Wno-interference-size -Wno-maybe-uninitialized -fvisibility=hidden -fopenmp -MD -MT caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o -MF caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o.d -o caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o -c /home/xyenchi/pytorch/build/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp c++: fatal error: Killed signal terminated program cc1plus compilation terminated. ninja: build stopped: subcommand failed. 关了各种优化和并行之后，再跑一天还是 oom。\n换个gcc版本吧\nexport CC=gcc-13 export CXX=g++-13 # 架构 export USE_CUDA=0 export USE_ROCM=0 export USE_HIP=0 export USE_TRITON=0 export USE_NCCL=0 # 分布式 export USE_DISTRIBUTED=0 export USE_GLOO=0 export USE_TENSORPIPE=0 export USE_MPI=0 # 性能组件 export USE_MKLDNN=0 export USE_OPENMP=0 # 构建规模 export BUILD_TEST=0 export BUILD_CAFFE2=0 # 内存保护 export MAX_JOBS=1 export CFLAGS=\"-O1 -g0\" export CXXFLAGS=\"-O1 -g0\" gcc降到13关了各种优化之后也跑出来了。\n热烈祝贺。\n","wordCount":"501","inLanguage":"en","image":"https://xyenchi.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2026-01-05T00:00:03Z","dateModified":"2026-01-05T00:00:03Z","author":{"@type":"Person","name":"xyenchi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xyenchi.github.io/nonsence/20260106/"},"publisher":{"@type":"Organization","name":"xyenchi's blog","logo":{"@type":"ImageObject","url":"https://xyenchi.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xyenchi.github.io/ accesskey=h title="xyenchi's blog (Alt + H)">xyenchi's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://xyenchi.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://xyenchi.github.io/record/ title=Record><span>Record</span></a></li><li><a href=https://xyenchi.github.io/perf/ title=Perf><span>Perf</span></a></li><li><a href=https://xyenchi.github.io/note/ title=Note><span>Note</span></a></li><li><a href=https://xyenchi.github.io/nonsence/ title=Nonsence><span>Nonsence</span></a></li><li><a href=https://xyenchi.github.io/novel/ title=Novel><span>Novel</span></a></li><li><a href=https://xyenchi.github.io/about/ title=About><span>About</span></a></li><li><a href=https://xyenchi.github.io/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Pytorch RISC-V</h1><div class=post-meta><span title='2026-01-05 00:00:03 +0000 UTC'>January 5, 2026</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;501 words&nbsp;·&nbsp;xyenchi</div></header><div class=post-content><h3 id=官方-github-仓库ci>官方 github 仓库CI<a hidden class=anchor aria-hidden=true href=#官方-github-仓库ci>#</a></h3><p>起了一个 ubuntu RISC-V 的 docker，使用 gcc14 和 python 3.12，但是 fail 很久了没修。
配置文件<a href=https://github.com/pytorch/pytorch/blob/main/.ci/docker/ubuntu-cross-riscv/Dockerfile>链接</a></p><h3 id=x86-cross>x86 cross<a hidden class=anchor aria-hidden=true href=#x86-cross>#</a></h3><p>酸鸽给 ArchLinux RISC-V python-pytorch 2.6.0 打了包，patch 文件<a href=https://github.com/felixonmars/archriscv-packages/blob/master/python-pytorch/riscv64.patch>链接</a></p><p>在 K1 上安装试了一下，不能直接用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Python</span> <span class=mf>3.13.11</span> <span class=p>(</span><span class=n>main</span><span class=p>,</span> <span class=n>Dec</span> <span class=mi>17</span> <span class=mi>2025</span><span class=p>,</span> <span class=mi>07</span><span class=p>:</span><span class=mi>50</span><span class=p>:</span><span class=mi>59</span><span class=p>)</span> <span class=p>[</span><span class=n>GCC</span> <span class=mf>15.2.1</span> <span class=mi>20251112</span><span class=p>]</span> <span class=n>on</span> <span class=n>linux</span>
</span></span><span class=line><span class=cl><span class=n>Type</span> <span class=s2>&#34;help&#34;</span><span class=p>,</span> <span class=s2>&#34;copyright&#34;</span><span class=p>,</span> <span class=s2>&#34;credits&#34;</span> <span class=ow>or</span> <span class=s2>&#34;license&#34;</span> <span class=k>for</span> <span class=n>more</span> <span class=n>information</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;python-input-0&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;/usr/lib/python3.13/site-packages/torch/__init__.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>405</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>torch._C</span> <span class=kn>import</span> <span class=o>*</span>  <span class=c1># noqa: F403</span>
</span></span><span class=line><span class=cl>    <span class=o>^^^^^^^^^^^^^^^^^^^^^^</span>
</span></span><span class=line><span class=cl><span class=ne>ImportError</span><span class=p>:</span> <span class=n>libprotobuf</span><span class=o>.</span><span class=n>so</span><span class=mf>.29.2.0</span><span class=p>:</span> <span class=n>cannot</span> <span class=nb>open</span> <span class=n>shared</span> <span class=nb>object</span> <span class=n>file</span><span class=p>:</span> <span class=n>No</span> <span class=n>such</span> <span class=n>file</span> <span class=ow>or</span> <span class=n>directory</span>
</span></span></code></pre></div><p>经查询 ArchLinux 上的 libprotobuf 版本为 31，但是进行软链接仍找不到，于是尝试重新构建。</p><p>既然已经打成功了早期版本的包，何不复用。于是学习了 ArchLinux 打包<a href=https://github.com/felixonmars/archriscv-packages/wiki/%E5%AE%8C%E5%85%A8%E6%96%B0%E4%BA%BA%E6%8C%87%E5%8D%97>指南</a>
其中 asp 已不可用，使用<code>pkgctl repo clone --protocol=https python-pytorch</code>获取最新版 ArchLinux 官方 PKGBUILD。根据酸鸽的riscv64 patch进行修改。<br>主要是禁用了 cuda 删除了一些 RISC-V 中没有的包依赖。<br>跑了一整天摸鱼之后发现，-march=rv64gc 被错误地 parse 了。</p><pre tabindex=0><code>copying torch/utils/data/datapipes/datapipe.pyi -&gt; build/lib.linux-riscv64-cpython-313/torch/utils/data/datapipes
running build_ext
-- Building with NumPy bindings
-- Not using cuDNN
-- Not using CUDA
-- Not using XPU
-- Not using MKLDNN
-- Not using NCCL
-- Building with distributed package: 
  -- USE_TENSORPIPE=True
  -- USE_GLOO=True
  -- USE_MPI=False
-- Not using ITT
Copying functorch._C from functorch/functorch.so to /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so
copying functorch/functorch.so -&gt; /build/python-pytorch/src/pytorch/build/lib.linux-riscv64-cpython-313/functorch/_C.cpython-313-riscv64-linux-gnu.so
building &#39;torch._C&#39; extension
creating build/temp.linux-riscv64-cpython-313/torch/csrc
-march=rv64gc -mabi=lp64d -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fno-omit-frame-pointer -fPIC -I/usr/include/python3.13 -c torch/csrc/stub.c -o build/temp.linux-riscv64-cpython-313/torch/csrc/stub.o -Wall -Wextra -Wno-strict-overflow -Wno-unused-parameter -Wno-missing-field-initializers -Wno-unknown-pragmas -fno-strict-aliasing
error: command &#39;-march=rv64gc&#39; failed: No such file or directory

ERROR Backend subprocess exited when trying to invoke build_wheel
==&gt; ERROR: A failure occurred in build().
    Aborting...
==&gt; ERROR: Build failed, check /var/lib/archbuild/extra-riscv64/xyenchi/build
</code></pre><p>于是删了 PKGBUILD 中加 add_definition 到 cmake 里面的方法，写了 CFLAGS 和 CXXFLAGS，重新跑。<br>看起来还是会把 CFLAGS 识别错误，可能原本的 CC 不存在，改成 /usr/bin/gcc 试试。<br>改 /usr/bin/gcc 挺成功的，就是找不到 ROCm 相关的 .so 文件。 貌似 ROCm 不支持 RISC-V 但是旧版本的打出来了。禁用掉试试。<br>使用该 <a href=https://github.com/XYenChi/PKGBUILD-archlinux-riscv/blob/master/PKGBUILD>PKGBUILD</a> 可以打出 pytorch 2.9.1，但仍需从 ArchLinux 官方 GitLab 仓库拉取相应 patch。</p><h3 id=k1-native>K1 native<a hidden class=anchor aria-hidden=true href=#k1-native>#</a></h3><p>官方文档上用的是 conda 的脚本，但是没有找到可以直接用的 conda，不是很懂，但是算了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>source</span> .venv/bin/activate
</span></span><span class=line><span class=cl>pip install -U pip setuptools wheel
</span></span><span class=line><span class=cl>pip install -r requirements.txt
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USE_CUDA</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USE_NCCL</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USE_DISTRIBUTED</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USE_MPI</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USE_GLOO</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>USE_MKLDNN</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>BUILD_TEST</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>BUILD_CAFFE2</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>python setup.py develop
</span></span></code></pre></div><p>起一个 python 虚拟环境，禁用掉只有 x86 能用的子模块跑，摸鱼一整天之后，成功oom了。</p><pre tabindex=0><code>FAILED: [code=1] caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o
/usr/bin/c++ -DAT_PER_OPERATOR_HEADERS -DCAFFE2_BUILD_MAIN_LIB -DCPUINFO_SUPPORTED_PLATFORM=1 -DFMT_HEADER_ONLY=1 -DHAVE_MALLOC_USABLE_SIZE=1 -DHAVE_MMAP=1 -DHAVE_POSIX_FALLOCATE=1 -DHAVE_SHM_OPEN=1 -DHAVE_SHM_UNLINK=1 -DMINIZ_DISABLE_ZIP_READER_CRC32_CHECKS -DONNXIFI_ENABLE_EXT=1 -DONNX_ML=1 -DONNX_NAMESPACE=onnx_torch -DUSE_EXTERNAL_MZCRC -D_FILE_OFFSET_BITS=64 -Dtorch_cpu_EXPORTS -I/home/xyenchi/pytorch/build/aten/src -I/home/xyenchi/pytorch/aten/src -I/home/xyenchi/pytorch/build -I/home/xyenchi/pytorch -I/home/xyenchi/pytorch/nlohmann -I/home/xyenchi/pytorch/moodycamel -I/home/xyenchi/pytorch/torch/csrc/api -I/home/xyenchi/pytorch/torch/csrc/api/include -I/home/xyenchi/pytorch/caffe2/aten/src/TH -I/home/xyenchi/pytorch/build/caffe2/aten/src/TH -I/home/xyenchi/pytorch/build/caffe2/aten/src -I/home/xyenchi/pytorch/build/caffe2/../aten/src -I/home/xyenchi/pytorch/torch/csrc -I/home/xyenchi/pytorch/torch/headeronly -I/home/xyenchi/pytorch/third_party/miniz-3.0.2 -I/home/xyenchi/pytorch/third_party/kineto/libkineto/include -I/home/xyenchi/pytorch/third_party/cpp-httplib -I/home/xyenchi/pytorch/aten/src/ATen/.. -I/home/xyenchi/pytorch/c10/.. -I/home/xyenchi/pytorch/third_party/cpuinfo/include -I/home/xyenchi/pytorch/third_party/FP16/include -I/home/xyenchi/pytorch/third_party/fmt/include -I/home/xyenchi/pytorch/third_party/onnx -I/home/xyenchi/pytorch/build/third_party/onnx -I/home/xyenchi/pytorch/third_party/flatbuffers/include -isystem /home/xyenchi/pytorch/third_party/protobuf/src -isystem /home/xyenchi/pytorch/cmake/../third_party/eigen -isystem /home/xyenchi/pytorch/INTERFACE -isystem /home/xyenchi/pytorch/third_party/nlohmann/include -isystem /home/xyenchi/pytorch/third_party/concurrentqueue -isystem /home/xyenchi/pytorch/build/include -fvisibility-inlines-hidden -DNDEBUG -DSYMBOLICATE_MOBILE_DEBUG_HANDLE -O2 -fPIC -DC10_NODEPRECATED -Wall -Wextra -Werror=return-type -Werror=non-virtual-dtor -Werror=range-loop-construct -Werror=bool-operation -Wnarrowing -Wno-missing-field-initializers -Wno-unknown-pragmas -Wno-unused-parameter -Wno-strict-overflow -Wno-strict-aliasing -Wno-stringop-overflow -Wsuggest-override -Wno-psabi -Wno-error=old-style-cast -faligned-new -Wno-maybe-uninitialized -fno-math-errno -fno-trapping-math -Werror=format -Wno-dangling-reference -Wno-error=dangling-reference -Wno-stringop-overflow -O3 -DNDEBUG -DNDEBUG -fPIC -fdiagnostics-color=always -Wall -Wextra -Wdeprecated -Wunused -Wno-unused-parameter -Wno-missing-field-initializers -Wno-array-bounds -Wno-unknown-pragmas -Wno-strict-overflow -Wno-strict-aliasing -Wredundant-move -Wno-interference-size -Wno-maybe-uninitialized -fvisibility=hidden -fopenmp -MD -MT caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o -MF caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o.d -o caffe2/CMakeFiles/torch_cpu.dir/__/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp.o -c /home/xyenchi/pytorch/build/aten/src/ATen/RegisterCompositeExplicitAutograd_0.cpp
c++: fatal error: Killed signal terminated program cc1plus
compilation terminated.
ninja: build stopped: subcommand failed.
</code></pre><p>关了各种优化和并行之后，再跑一天还是 oom。<br>换个gcc版本吧</p><pre tabindex=0><code>export CC=gcc-13
export CXX=g++-13

# 架构
export USE_CUDA=0
export USE_ROCM=0
export USE_HIP=0
export USE_TRITON=0
export USE_NCCL=0

# 分布式
export USE_DISTRIBUTED=0
export USE_GLOO=0
export USE_TENSORPIPE=0
export USE_MPI=0

# 性能组件
export USE_MKLDNN=0
export USE_OPENMP=0

# 构建规模
export BUILD_TEST=0
export BUILD_CAFFE2=0

# 内存保护
export MAX_JOBS=1
export CFLAGS=&#34;-O1 -g0&#34;
export CXXFLAGS=&#34;-O1 -g0&#34;
</code></pre><p>gcc降到13关了各种优化之后也跑出来了。<br>热烈祝贺。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://xyenchi.github.io/>xyenchi's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>